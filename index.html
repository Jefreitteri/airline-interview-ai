<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Airline Interview AI</title>
</head>
<body>

<h1>Airline Interview AI</h1>
<button id="startBtn">Start Interview</button>
<button id="stopBtn" disabled>Stop</button>

<script>
let pc;
let localStream;
let dataChannel;

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");

startBtn.onclick = async () => {
  startBtn.disabled = true;
  stopBtn.disabled = false;

  // ðŸ”¹ Get ephemeral token
  const tokenResponse = await fetch("/api/realtime-token", { method: "POST" });
  const tokenData = await tokenResponse.json();
  const ephemeralKey = tokenData.client_secret?.value;

  if (!ephemeralKey) {
    alert("Failed to get realtime token");
    return;
  }

  // ðŸ”¹ Create WebRTC connection
  pc = new RTCPeerConnection();

  const audio = document.createElement("audio");
  audio.autoplay = true;
  pc.ontrack = e => audio.srcObject = e.streams[0];

  // ðŸ”¹ Get mic
  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  for (const track of localStream.getTracks()) {
    pc.addTrack(track, localStream);
  }

  // ðŸ”¹ Data channel
  dataChannel = pc.createDataChannel("oai-events");

  dataChannel.onopen = () => {
    console.log("Data channel open. Sending interview prompt...");

    dataChannel.send(JSON.stringify({
      type: "response.create",
      response: {
        instructions: `You are a three-member airline interview panel conducting a structured competency-based interview for a pilot position.

This is a realistic interview simulation designed as a training tool for airline job preparation.

You are not a coach during the interview phase.
You do not provide feedback during the interview.
You do not provide model answers during the interview.
Ask one question per time.
Do not announce the phase.
Do not use filler acknowledgements such as:
- "Thank you for your answer"
- "Okay"
- "I see"
- "Alright"

After the candidate finishes speaking, move directly to the next question or follow-up without verbal acknowledgement.
Do not repeat or paraphrase the candidate's answer unless clarification is necessary.

The interview must follow the complete structured five phase format:
Calibration â†’ HR & Fit â†’ Behavioural (all competencies mandatory) â†’ Technical â†’ Motivation â†’ Debrief.

The behavioural section must be the longest.
Minimum 8 primary behavioural scenarios (one per competency).
Do not move to technical before all competencies are explored.

Technical segment: 4â€“6 questions from mixed categories. Adjust to experience level.

After interview completion say:
"This concludes the interview simulation. We will now move to the debrief."

Debrief must include:
1. Overall impression (Readiness level + strengths + development areas)
2. Behavioural evaluation
3. Technical evaluation
4. Interview behaviour
5. Priority development plan (3â€“5 specific items)

No praise. No humiliation. No model answers.

Begin immediately with:

â€œWe will conduct an airline interview simulation. Please answer using real examples from your experience.â€

Ask the first calibration question.`,
        modalities: ["audio"]
      }
    }));
  };

  // ðŸ”¹ Create offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  const baseUrl = "https://api.openai.com/v1/realtime";
  const model = "gpt-4o-realtime-preview";

  const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${ephemeralKey}`,
      "Content-Type": "application/sdp"
    },
    body: offer.sdp
  });

  const answerSDP = await sdpResponse.text();
  await pc.setRemoteDescription({ type: "answer", sdp: answerSDP });

  console.log("Realtime interview started");
};

stopBtn.onclick = () => {
  stopBtn.disabled = true;
  startBtn.disabled = false;

  if (pc) pc.close();

  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
  }

  console.log("Interview stopped");
};
</script>

</body>
</html>
