<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Airline Interview AI (Voice)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    button { margin-right: 10px; padding: 10px 14px; }
    #status { margin: 10px 0; color: #444; }
    #log { white-space: pre-wrap; font-size: 12px; color: #333; background:#f6f6f6; padding:10px; border-radius:8px; max-height: 40vh; overflow:auto; }
  </style>
</head>
<body>
  <h1>Airline Interview AI 123 (Voice)</h1>

  <button id="startBtn">Start</button>
  <button id="stopBtn" disabled>Stop</button>

  <div id="status">Idle.</div>
  <div id="log"></div>

<script>
let pc, localStream, dataChannel, audioEl;

const startBtn = document.getElementById("startBtn");
const stopBtn  = document.getElementById("stopBtn");
const statusEl = document.getElementById("status");
const logEl    = document.getElementById("log");

function log(msg){ logEl.textContent = (logEl.textContent + msg + "\n").slice(-8000); }

async function start(){
  startBtn.disabled = true;
  stopBtn.disabled = false;
  logEl.textContent = "";
  statusEl.textContent = "Requesting microphone…";

  const tokenResp = await fetch("/api/realtime-token", { method: "POST" });
  const tokenData = await tokenResp.json().catch(()=>({}));
  const ephemeralKey = tokenData?.client_secret?.value;

  if (!ephemeralKey) {
    console.log(tokenData);
    alert("Failed to get realtime token. Check Vercel env OPENAI_API_KEY + function logs.");
    startBtn.disabled = false;
    stopBtn.disabled = true;
    statusEl.textContent = "Idle.";
    return;
  }

  pc = new RTCPeerConnection();

  audioEl = document.createElement("audio");
  audioEl.autoplay = true;
  audioEl.playsInline = true;
  pc.ontrack = (e) => { audioEl.srcObject = e.streams[0]; };

  dataChannel = pc.createDataChannel("oai-events");
  dataChannel.onmessage = (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg?.type === "error") log("ERROR: " + ev.data);
    } catch {}
  };

  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  statusEl.textContent = "Connecting…";

  const baseUrl = "https://api.openai.com/v1/realtime";
  const model = "gpt-4o-realtime-preview";

  const sdpResp = await fetch(`${baseUrl}?model=${encodeURIComponent(model)}`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${ephemeralKey}`,
      "Content-Type": "application/sdp"
    },
    body: offer.sdp
  });

  const answerSDP = await sdpResp.text();
  await pc.setRemoteDescription({ type: "answer", sdp: answerSDP });

  statusEl.textContent = "Connected. Speak normally.";
  log("Connected.");
}

function stop(){
  stopBtn.disabled = true;
  startBtn.disabled = false;

  try { if (dataChannel) dataChannel.close(); } catch {}
  dataChannel = null;

  try { if (pc) pc.close(); } catch {}
  pc = null;

  try { if (localStream) localStream.getTracks().forEach(t => t.stop()); } catch {}
  localStream = null;

  statusEl.textContent = "Stopped.";
  log("Stopped.");
}

startBtn.onclick = () => start().catch(e => {
  console.error(e);
  alert(e?.message || String(e));
  log("START ERROR: " + (e?.message || String(e)));
  stop();
});

stopBtn.onclick = stop;
</script>
</body>
</html>
