<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Airline Interview AI</title>
</head>
<body>

<h1>Airline Interview AI</h1>
<button id="startBtn">Start Interview</button>
<button id="stopBtn" disabled>Stop</button>

<script>
let pc;
let localStream;
let dataChannel;

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");

const SYSTEM_PROMPT = `You are a three-member airline interview panel conducting a structured competency-based interview for a pilot position.

This is a realistic interview simulation designed as a training tool for airline job preparation.

You are not a coach during the interview phase.
You do not provide feedback during the interview.
You do not provide model answers during the interview.
Ask one question per time.
Do not announce the phase.
Do not use filler acknowledgements such as:
- "Thank you for your answer"
- "Okay"
- "I see"
- "Alright"
After the candidate finishes speaking, move directly to the next question or follow-up without verbal acknowledgement.
Do not repeat or paraphrase the candidate's answer unless clarification is necessary.

However, after the interview is completed, you will enter a structured debrief mode.

Start with:
"We will conduct an airline interview simulation. Please answer using real examples from your experience."

Then begin Phase 1 calibration questions.

Maintain strict structure throughout.
`;

startBtn.onclick = async () => {
  startBtn.disabled = true;
  stopBtn.disabled = false;

  const tokenResponse = await fetch("/api/realtime-token", { method: "POST" });
  const tokenData = await tokenResponse.json();
  const ephemeralKey = tokenData.client_secret?.value;

  if (!ephemeralKey) {
    alert("Failed to get realtime token");
    return;
  }

  pc = new RTCPeerConnection();

  const audio = document.createElement("audio");
  audio.autoplay = true;
  pc.ontrack = e => audio.srcObject = e.streams[0];

  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  for (const track of localStream.getTracks()) {
    pc.addTrack(track, localStream);
  }

  dataChannel = pc.createDataChannel("oai-events");

  dataChannel.onopen = () => {

    // Send system prompt
    dataChannel.send(JSON.stringify({
      type: "session.update",
      session: {
        instructions: SYSTEM_PROMPT,
        modalities: ["audio", "text"]
      }
    }));

    // Force first response
    dataChannel.send(JSON.stringify({
      type: "response.create"
    }));
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  const baseUrl = "https://api.openai.com/v1/realtime";
  const model = "gpt-4o-realtime-preview";

  const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${ephemeralKey}`,
      "Content-Type": "application/sdp"
    },
    body: offer.sdp
  });

  const answerSDP = await sdpResponse.text();

  await pc.setRemoteDescription({
    type: "answer",
    sdp: answerSDP
  });

  console.log("Realtime interview started");
};

stopBtn.onclick = () => {
  stopBtn.disabled = true;
  startBtn.disabled = false;

  if (pc) pc.close();

  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
  }

  console.log("Interview stopped");
};
</script>

</body>
</html>
