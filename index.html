<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Airline Interview AI</title>
</head>
<body>

<h1>Airline Interview AI</h1>
<button id="startBtn">Start Interview</button>
<button id="stopBtn" disabled>Stop</button>

<script>
let pc;
let localStream;
let dataChannel;

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");

startBtn.onclick = async () => {
  startBtn.disabled = true;
  stopBtn.disabled = false;

  // 1️⃣ Get ephemeral token from backend
  const tokenResponse = await fetch("/api/realtime-token", { method: "POST" });
  const tokenData = await tokenResponse.json();

  const ephemeralKey = tokenData.client_secret?.value;

  if (!ephemeralKey) {
    alert("Failed to get realtime token");
    return;
  }

  // 2️⃣ Create WebRTC connection
  pc = new RTCPeerConnection();

  // 3️⃣ Play AI audio
  const audio = document.createElement("audio");
  audio.autoplay = true;
  pc.ontrack = e => audio.srcObject = e.streams[0];

  // 4️⃣ Get microphone
  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  for (const track of localStream.getTracks()) {
    pc.addTrack(track, localStream);
  }

  // 5️⃣ Data channel (optional)
  dataChannel = pc.createDataChannel("oai-events");

  // 6️⃣ Create offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  // 7️⃣ Send offer to OpenAI Realtime endpoint
  const baseUrl = "https://api.openai.com/v1/realtime";
  const model = "gpt-4o-realtime-preview";

  const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${ephemeralKey}`,
      "Content-Type": "application/sdp"
    },
    body: offer.sdp
  });

  const answerSDP = await sdpResponse.text();

  await pc.setRemoteDescription({ type: "answer", sdp: answerSDP });

  console.log("Realtime interview started");
};

stopBtn.onclick = () => {
  stopBtn.disabled = true;
  startBtn.disabled = false;

  if (pc) {
    pc.close();
  }

  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
  }

  console.log("Interview stopped");
};
</script>

</body>
</html>
