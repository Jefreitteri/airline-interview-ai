<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Airline Interview AI – Voice</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; max-width: 900px; }
    button { padding: 12px 16px; font-size: 16px; }
    #status { margin-top: 12px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Airline Interview AI – Voice</h1>
  <button id="start">Start Voice Interview</button>
  <div id="status">Idle</div>

<script>
let pc, dc, audioEl;

document.getElementById("start").addEventListener("click", start);

async function start() {
  const status = document.getElementById("status");
  status.innerText = "Starting...";

  // 1️⃣ Get ephemeral token from backend
  const tokenRes = await fetch("/api/token");
  const tokenData = await tokenRes.json();
  const EPHEMERAL_KEY = tokenData.value;

  if (!EPHEMERAL_KEY) {
    alert("Token error");
    return;
  }

  // 2️⃣ Create peer connection
  pc = new RTCPeerConnection();

  // Remote audio playback
  audioEl = document.createElement("audio");
  audioEl.autoplay = true;
  document.body.appendChild(audioEl);
  pc.ontrack = e => audioEl.srcObject = e.streams[0];

  // 3️⃣ Microphone input
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  pc.addTrack(stream.getTracks()[0]);

  // 4️⃣ Data channel
  dc = pc.createDataChannel("oai-events");

  dc.onopen = () => {
    status.innerText = "Connected – Interview running";

    const instructions = `
You are a three-member airline interview panel conducting a structured competency-based interview for a pilot position.

This is a realistic interview simulation designed as a training tool for airline job preparation.

CRITICAL REALTIME RULES:
- Do NOT interrupt the candidate while they are speaking.
- Wait until the candidate clearly stops speaking before responding.
- Do NOT use filler acknowledgements.
- Move directly to the next question after the candidate finishes.
- Do NOT paraphrase answers unless clarification is required.
- Maintain pacing consistent with a 40–50 minute airline screening interview.

You are NOT a coach during the interview phase.
You do NOT provide feedback during the interview.
You do NOT provide model answers during the interview.
Ask ONE primary question at a time.

If the candidate asks for help:
“In a real airline interview I cannot coach you. Please answer using a real example.”

If the candidate tries to skip a question:
Rephrase and ask again.

INTERVIEW STRUCTURE:
- Calibration
- HR & Fit
- Behavioural (must cover all competencies)
- Technical (4–6 questions)
- Motivation & Realism
- Debrief

Behavioural section must be the longest part.
Do not move to technical before all competencies are covered.

Start with:

“We will conduct an airline interview simulation. Please answer using real examples from your experience.”

Then begin Phase 1.
`;

    dc.send(JSON.stringify({
      type: "session.update",
      session: {
        instructions,
        turn_detection: { type: "server_vad", silence_duration_ms: 1200 }
      }
    }));

    dc.send(JSON.stringify({
      type: "response.create",
      response: {
        modalities: ["audio"],
        instructions: "Start the interview."
      }
    }));
  };

  // 5️⃣ SDP exchange
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  const sdpRes = await fetch("https://api.openai.com/v1/realtime/calls", {
    method: "POST",
    body: offer.sdp,
    headers: {
      Authorization: `Bearer ${EPHEMERAL_KEY}`,
      "Content-Type": "application/sdp"
    }
  });

  const answer = { type: "answer", sdp: await sdpRes.text() };
  await pc.setRemoteDescription(answer);
}
</script>
</body>
</html>
