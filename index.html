<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Airline Interview AI (Voice)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; max-width: 900px; }
    button { padding: 10px 14px; font-size: 16px; }
    #status { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Airline Interview AI â€“ Voice</h1>
  <button id="start">Start voice interview</button>
  <div id="status">Idle</div>

<script>
let pc, dc, audioEl;

document.getElementById("start").addEventListener("click", start);

async function start() {
  document.getElementById("status").innerText = "Starting...";

  // 1) Get ephemeral token from backend
  const tokenRes = await fetch("/api/token");
  const tokenData = await tokenRes.json();
  const EPHEMERAL_KEY = tokenData.value;

  if (!EPHEMERAL_KEY) {
    alert("Token error");
    return;
  }

  // 2) Create peer connection
  pc = new RTCPeerConnection();

  // Remote audio playback
  audioEl = document.createElement("audio");
  audioEl.autoplay = true;
  document.body.appendChild(audioEl);
  pc.ontrack = e => audioEl.srcObject = e.streams[0];

  // Microphone
  const ms = await navigator.mediaDevices.getUserMedia({ audio: true });
  pc.addTrack(ms.getTracks()[0]);

  // Data channel
  dc = pc.createDataChannel("oai-events");

  dc.onopen = () => {
    document.getElementById("status").innerText = "Connected";

    const instructions = `
PASTE YOUR FULL INTERVIEW PROMPT HERE
`;

    dc.send(JSON.stringify({
      type: "session.update",
      session: {
        instructions,
        turn_detection: { type: "server_vad", silence_duration_ms: 1200 }
      }
    }));

    dc.send(JSON.stringify({
      type: "response.create",
      response: {
        modalities: ["audio"],
        instructions: "Start the airline interview."
      }
    }));
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  const sdpRes = await fetch("https://api.openai.com/v1/realtime/calls", {
    method: "POST",
    body: offer.sdp,
    headers: {
      Authorization: `Bearer ${EPHEMERAL_KEY}`,
      "Content-Type": "application/sdp"
    }
  });

  const answer = { type: "answer", sdp: await sdpRes.text() };
  await pc.setRemoteDescription(answer);
}
</script>
</body>
</html>
